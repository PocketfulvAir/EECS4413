select dy.city, dy.cat, dy.#books from (select city, max(#books) as #books from (select C.city, B.cat, count(*) as #books from purchase as P join customer as C on P.cid = C.cid join book as B on P.title = B.title and P.year = B.year group by C.city, B.cat) group by city) as dx inner join (select C.city, B.cat, count(*) as #books from purchase as P join customer as C on P.cid = C.cid join book as B on P.title = B.title and P.year = B.year group by C.city, B.cat) as dy on dx.city = dy.city and dx.#books = dy.#books order by dy.city, dy.cat