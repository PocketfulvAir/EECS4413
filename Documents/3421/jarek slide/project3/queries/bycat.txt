select customer.name, cat, sd.paid as paid from (select wz.cid, wz.club, wz.cat, sum (wz.paid) as paid from (select dx.cid, dx.club, dx.cat, offer.price * dx.qnty as paid from (select cid, club, book.cat, book.title, qnty from purchase inner join book on purchase.title = book.title order by cid, club, book.cat, book.title, qnty) as dx inner join offer on dx.title = offer.title group by dx.cid, dx.club, dx.cat, offer.Price *dx.qnty order by dx.cid, dx.club, dx.cat, offer.Price*dx.qnty) as wz group by wz.cid,  wz.club, wz.cat order by wz.cid, wz.club, wz.cat) as sd inner join customer On sd.cid = customer.cid limit 135